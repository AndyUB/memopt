Benchmarking Transformer models: FP32 vs FP16 Memory Usage
Device: cuda

============================================================
Benchmarking TRANSFORMER_SMALL
============================================================
Config: {'vocab_size': 50257, 'num_layers': 12, 'd_model': 768, 'num_heads': 12, 'd_ff': 3072}
Context length: 256, Batch size: 4

Testing FP32 (no mixed precision)...
FP32 Memory Usage:
  After model:    0.764 GB
  After forward:  2.632 GB
  After backward: 3.044 GB
  Peak:           3.810 GB

Testing FP16 (autocast only)...
FP16 (autocast only) Memory Usage:
  After model:    0.781 GB
  After forward:  2.271 GB
  After backward: 2.477 GB
  Peak:           3.669 GB

Testing FP16 (no master copy)...
FP16 (no master copy) Memory Usage:
  After model:    1.622 GB
  After forward:  2.222 GB
  After backward: 2.222 GB
  Peak:           2.222 GB

Testing FP16 (default mixed precision)...
FP16 (default) Memory Usage:
  After model:    2.043 GB
  After forward:  2.610 GB
  After backward: 2.610 GB
  Peak:           4.040 GB

============================================================
Memory Comparison:
============================================================
Peak memory FP32:        3.810 GB
Peak memory autocast:    3.669 GB
Peak memory no_master:   2.222 GB
Peak memory default:     4.040 GB

============================================================
Benchmarking TRANSFORMER_LARGE
============================================================
Config: {'vocab_size': 50257, 'num_layers': 36, 'd_model': 1280, 'num_heads': 20, 'd_ff': 5120}
Context length: 256, Batch size: 4

Testing FP32 (no mixed precision)...
FP32 Memory Usage:
  After model:    4.422 GB
  After forward:  12.040 GB
  After backward: 12.452 GB
  Peak:           18.556 GB

Testing FP16 (autocast only)...
FP16 (autocast only) Memory Usage:
  After model:    4.422 GB
  After forward:  11.299 GB
  After backward: 11.583 GB
  Peak:           18.455 GB

Testing FP16 (no master copy)...
FP16 (no master copy) Memory Usage:
  After model:    8.955 GB
  After forward:  10.874 GB
  After backward: 10.874 GB
  Peak:           10.874 GB

Testing FP16 (default mixed precision)...
FP16 (default) Memory Usage:
  After model:    11.133 GB
  After forward:  13.054 GB
  After backward: 13.054 GB
  Peak:           20.665 GB

============================================================
Memory Comparison:
============================================================
Peak memory FP32:        18.556 GB
Peak memory autocast:    18.455 GB
Peak memory no_master:   10.874 GB
Peak memory default:     20.665 GB

============================================================
Results exported to: results/memory_mixprec_benchmark_20251209_234242.csv
============================================================
